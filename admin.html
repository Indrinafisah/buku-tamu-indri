<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Admin Buku Tamu KPU</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0px 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            display: block;
            background: #f0f0f0;
        }

        .login-title {
            color: #d32f2f;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: 600;
        }

        .login-form {
            text-align: left;
        }

        .login-group {
            margin-bottom: 20px;
        }

        .login-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .login-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .login-group input:focus {
            outline: none;
            border-color: #d32f2f;
        }

        .captcha-container {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .captcha-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .captcha-code {
            background: #fff;
            padding: 15px 20px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 8px;
            color: #d32f2f;
            border: 2px solid #ddd;
            text-decoration: line-through;
            text-decoration-color: #999;
            text-decoration-thickness: 1px;
            user-select: none;
        }

        .captcha-refresh {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .captcha-refresh:hover {
            background: #5a6268;
        }

        .captcha-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            text-align: center;
            letter-spacing: 4px;
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
        }

        .captcha-label {
            margin-bottom: 8px;
            font-size: 14px;
            color: #666;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-btn:hover {
            background: #a71d1d;
        }

        .login-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            display: none;
        }

        .debug-info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 12px;
            text-align: left;
        }

        .admin-container {
            display: none;
        }

        header { 
            text-align: center; 
            margin-bottom: 20px; 
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }

        .logo-kpu {
            width: 80px;
            height: 80px;
            background: #f0f0f0;
        }

        header h2 { 
            color: #d32f2f; 
            margin: 0;
            font-size: 28px;
        }

        .admin-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #f0f0f0;
        }

        .admin-user {
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #757575;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: #616161;
        }
        
        .table-container {
            overflow-x: auto;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { padding: 10px; border: 1px solid #ddd; font-size: 14px; text-align: left; }
        th { background: #d32f2f; color: white; }
        tr:nth-child(even) { background: #f2f2f2; }
        
        .refresh, .btn {
            margin: 2px; padding: 5px 10px;
            border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold; font-size: 12px;
        }
        
        .refresh { 
            display: block; margin: 10px auto 20px; 
            background: #d32f2f; color: white; 
            padding: 10px 20px; font-size: 14px;
        }
        .refresh:hover { background: #a71d1d; }
        
        .btn-edit { background: #2196f3; color: white; }
        .btn-edit:hover { background: #0d6efd; }
        
        .btn-delete { background: #e53935; color: white; }
        .btn-delete:hover { background: #b71c1c; }
        .btn-delete:disabled { background: #ccc; cursor: not-allowed; }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        footer { 
            text-align: center; 
            margin-top: 30px; 
            font-size: 14px; 
            font-weight: bold; 
            color: white;
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <div class="login-logo"></div>
            <h2 class="login-title">Admin Login</h2>
            <p style="color: #666; margin-bottom: 20px;">Masuk ke Panel Admin Buku Tamu KPU</p>
            
            <form class="login-form" id="loginForm">
                <div class="login-group">
                    <label for="username">üë§ Username:</label>
                    <input type="text" id="username" required placeholder="Masukkan username">
                </div>
                <div class="login-group">
                    <label for="password">üîí Password:</label>
                    <input type="password" id="password" required placeholder="Masukkan password">
                </div>
                
                <div class="captcha-container">
                    <div class="captcha-display">
                        <div class="captcha-code" id="captchaDisplay">LOADING</div>
                        <button type="button" class="captcha-refresh" id="refreshCaptcha">üîÑ Refresh</button>
                    </div>
                    <label class="captcha-label" for="captchaInput">üîê Masukkan kode CAPTCHA di atas:</label>
                    <input type="text" class="captcha-input" id="captchaInput" required placeholder="Masukkan kode CAPTCHA" maxlength="5">
                </div>
                
                <button type="submit" class="login-btn">Masuk Admin</button>
            </form>
            
            <div class="login-error" id="loginError"></div>
            
            <!-- Debug Info -->
            <div class="debug-info">
                <strong>DEBUG INFO:</strong><br>
                Username yang benar: <strong>admin_kpu</strong><br>
                Password yang benar: <strong>kpu2025</strong><br>
                Status: <span id="debugStatus">Memuat...</span><br>
                CAPTCHA: <span id="debugCaptcha">-</span>
            </div>
        </div>
    </div>

    <div id="adminSection" class="admin-container">
        <header>
            <div class="header-content">
                <div class="logo-kpu"></div>
                <div>
                    <h2>Admin Buku Tamu KPU</h2>
                    <p style="margin: 0; color: #666;">Panel Administrasi Data Tamu</p>
                </div>
            </div>
            <div class="admin-info">
                <div class="admin-user">
                    üë§ <strong>Administrator</strong> | üïí <span id="currentTime">Loading...</span>
                </div>
                <button class="logout-btn" id="logoutBtn">üö™ Logout</button>
            </div>
        </header>

        <div class="status" id="statusDiv"></div>
        <button class="refresh" id="refreshBtn">üîÑ Refresh Data</button>

        <div class="table-container">
            <h3>üìã Data Tamu</h3>
            <table id="dataTable">
                <tr><td style='text-align: center; padding: 20px;'>Loading...</td></tr>
            </table>
        </div>

        <div class="table-container">
            <h3>üìà Rekap Harian</h3>
            <table id="rekapTable">
                <tr><td style='text-align: center; padding: 20px;'>Loading...</td></tr>
            </table>
        </div>

        <footer>üèõÔ∏è Komisi Pemilihan Umum Grobogan</footer>
    </div>

    <script>
        // Global variables
        let captchaCode = "";
        const scriptURL = "https://script.google.com/macros/s/AKfycbxxzB7CdHkrP8swb7WYN0xt3gYp9DG7efiRmNAv-YZXmlivk5jpzYWHl5NvI4HfCjs6/exec";
        
        // Admin credentials
        const ADMIN_USERNAME = "admin_kpu";
        const ADMIN_PASSWORD = "kpu2025";

        // Debug function
        function debugLog(message) {
            console.log("[DEBUG] " + message);
            document.getElementById('debugStatus').textContent = message;
        }

        // Generate CAPTCHA
        function generateCaptcha() {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            captchaCode = '';
            for (let i = 0; i < 5; i++) {
                captchaCode += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            document.getElementById('captchaDisplay').textContent = captchaCode;
            document.getElementById('debugCaptcha').textContent = captchaCode;
            debugLog("CAPTCHA generated: " + captchaCode);
        }

        // Validate CAPTCHA
        function validateCaptcha() {
            const userInput = document.getElementById('captchaInput').value.toUpperCase().trim();
            const isValid = userInput === captchaCode;
            debugLog(`CAPTCHA validation: ${userInput} vs ${captchaCode} = ${isValid}`);
            return isValid;
        }

        // Show/Hide panels
        function showLoginPanel() {
            debugLog("Showing login panel");
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('adminSection').style.display = 'none';
            
            // Reset form
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('captchaInput').value = '';
            document.getElementById('loginError').style.display = 'none';
            generateCaptcha();
        }

        function showAdminPanel() {
            debugLog("Showing admin panel");
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';
            updateCurrentTime();
        }

        // Handle login
        function handleLogin(event) {
            event.preventDefault();
            debugLog("Login form submitted");
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorDiv = document.getElementById('loginError');
            
            debugLog(`Attempting login with: ${username} / ${password.length} chars`);
            
            // Reset error
            errorDiv.style.display = 'none';
            
            // Validate CAPTCHA first
            if (!validateCaptcha()) {
                showError('‚ùå Kode CAPTCHA salah!');
                generateCaptcha();
                document.getElementById('captchaInput').value = '';
                return false;
            }
            
            // Validate credentials
            if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                debugLog("Login successful!");
                
                // Save login status
                try {
                    sessionStorage.setItem('kpu_admin_logged_in', 'true');
                    sessionStorage.setItem('kpu_admin_user', username);
                    debugLog("Session data saved");
                } catch (e) {
                    debugLog("Error saving session: " + e.message);
                }
                
                // Show admin panel
                showAdminPanel();
                loadData();
                
            } else {
                debugLog("Login failed - wrong credentials");
                showError('‚ùå Username atau password salah!');
                generateCaptcha();
                document.getElementById('captchaInput').value = '';
            }
            
            return false;
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 3000);
        }

        // Check login status
        function checkLoginStatus() {
            try {
                const isLoggedIn = sessionStorage.getItem('kpu_admin_logged_in') === 'true';
                debugLog("Checking login status: " + isLoggedIn);
                
                if (isLoggedIn) {
                    showAdminPanel();
                    loadData();
                } else {
                    showLoginPanel();
                }
            } catch (e) {
                debugLog("Error checking login status: " + e.message);
                showLoginPanel();
            }
        }

        // Handle logout
        function handleLogout() {
            if (confirm('üö™ Yakin ingin logout?')) {
                try {
                    sessionStorage.removeItem('kpu_admin_logged_in');
                    sessionStorage.removeItem('kpu_admin_user');
                    debugLog("Logged out successfully");
                } catch (e) {
                    debugLog("Error during logout: " + e.message);
                }
                showLoginPanel();
            }
        }

        // Update current time
        function updateCurrentTime() {
            const now = new Date();
            
            const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                           'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            
            const dayName = days[now.getDay()];
            const day = now.getDate().toString().padStart(2, '0');
            const month = months[now.getMonth()];
            const year = now.getFullYear();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            const timeString = `${dayName}, ${day} ${month} ${year} - ${hours}:${minutes}:${seconds} WIB`;
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = timeString;
            }
        }

        // Show status message
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById("statusDiv");
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `status ${isError ? 'error' : 'success'}`;
                statusDiv.style.display = "block";
                
                setTimeout(() => {
                    statusDiv.style.display = "none";
                }, 3000);
            }
        }

        // Load data
        async function loadData() {
            debugLog("Loading data...");
            
            try {
                const timestamp = new Date().getTime();
                const url = scriptURL + "?action=read&t=" + timestamp;
                
                debugLog("Fetching from: " + url);
                
                const res = await fetch(url);
                
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                
                const responseText = await res.text();
                debugLog("Response received: " + responseText.substring(0, 100) + "...");
                
                let json;
                try {
                    json = JSON.parse(responseText);
                } catch (parseErr) {
                    throw new Error("Invalid JSON response");
                }

                const data = json.data || [];
                const rekap = json.rekap || [];

                debugLog(`Data loaded: ${data.length} rows, ${rekap.length} rekap`);

                // Update data table
                updateDataTable(data);
                updateRekapTable(rekap);

                showStatus("‚úÖ Data berhasil dimuat! (" + Math.max(0, data.length - 1) + " tamu)");

            } catch (err) {
                debugLog("Error loading data: " + err.message);
                showStatus("‚ùå Gagal memuat data! " + err.message, true);
                
                const dataTable = document.getElementById("dataTable");
                if (dataTable) {
                    dataTable.innerHTML = `<tr><td colspan='100%' style='text-align: center; padding: 20px; color: #d32f2f;'>
                        ‚ùå Error: ${err.message}
                    </td></tr>`;
                }
            }
        }

        // Update data table
        function updateDataTable(data) {
            const dataTable = document.getElementById("dataTable");
            if (!dataTable) return;
            
            dataTable.innerHTML = "";

            if (data.length === 0) {
                dataTable.innerHTML = "<tr><td colspan='100%' style='text-align: center; padding: 20px; color: #666;'>üì≠ Belum ada data tamu</td></tr>";
                return;
            }

            data.forEach((row, i) => {
                const tr = document.createElement("tr");

                row.forEach((cell) => {
                    const td = document.createElement(i === 0 ? "th" : "td");
                    td.textContent = cell || "";
                    tr.appendChild(td);
                });

                if (i === 0) {
                    const th = document.createElement("th");
                    th.textContent = "Aksi";
                    th.style.width = "120px";
                    tr.appendChild(th);
                } else {
                    const td = document.createElement("td");
                    
                    const editBtn = document.createElement("button");
                    editBtn.className = "btn btn-edit";
                    editBtn.textContent = "‚úèÔ∏è Edit";
                    editBtn.onclick = () => alert('Fitur edit dalam pengembangan');
                    
                    const deleteBtn = document.createElement("button");
                    deleteBtn.className = "btn btn-delete";
                    deleteBtn.textContent = "üóë Hapus";
                    deleteBtn.onclick = () => alert('Fitur delete dalam pengembangan');
                    
                    td.appendChild(editBtn);
                    td.appendChild(deleteBtn);
                    tr.appendChild(td);
                }

                dataTable.appendChild(tr);
            });
        }

        // Update rekap table
        function updateRekapTable(rekap) {
            const rekapTable = document.getElementById("rekapTable");
            if (!rekapTable) return;
            
            rekapTable.innerHTML = "";
            
            if (rekap.length === 0) {
                rekapTable.innerHTML = "<tr><td colspan='100%' style='text-align: center; padding: 20px; color: #666;'>üìä Belum ada data rekap</td></tr>";
                return;
            }

            rekap.forEach((row, i) => {
                const tr = document.createElement("tr");
                row.forEach((cell) => {
                    const td = document.createElement(i === 0 ? "th" : "td");
                    td.textContent = cell || "";
                    tr.appendChild(td);
                });
                rekapTable.appendChild(tr);
            });
        }

        // Initialize when page loads
        window.addEventListener('load', function() {
            debugLog("Page loaded, initializing...");
            
            // Add event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('refreshCaptcha').addEventListener('click', generateCaptcha);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            
            // Initialize
            generateCaptcha();
            checkLoginStatus();
            
            // Update time every second
            setInterval(updateCurrentTime, 1000);
            
            debugLog("Initialization complete");
        });
    </script>
</body>
</html>
